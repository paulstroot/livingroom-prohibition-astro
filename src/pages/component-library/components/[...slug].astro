---
import ComponentLayout from "@component-library/layouts/ComponentLayout.astro";
import { getCollection, render } from "astro:content";
// @ts-ignore
import { existsSync, readFileSync } from "fs";
import yaml from "js-yaml";

export async function getStaticPaths() {
  // Skip component library routes if DISABLE_COMPONENT_LIBRARY is set
  if (process.env.DISABLE_COMPONENT_LIBRARY === "true") {
    return [];
  }

  const schemaFiles = import.meta.glob("../../../components/**/schema.ts", {
    eager: true,
  });

  try {
    const components = await getCollection("docs-components");

    if (!components || components.length === 0) {
      return [];
    }

    const componentEntries = components.filter((entry) => {
      return entry && entry.id && !entry.id.includes("/examples/");
    });

    return componentEntries.map((entry) => {
      const slug = entry.id.replace(/^components\//, "").replace(/\/index$/, "");
      const parts = slug.split("/").filter(Boolean);
      const componentKey = parts.join("/");

      let schema = null;
      let configData = null;

      const camelCaseKey = componentKey
        .split("-")
        .map((part, index) => {
          if (index === 0) {
            return part.charAt(0).toUpperCase() + part.slice(1);
          }
          return part.charAt(0).toUpperCase() + part.slice(1);
        })
        .join("");

      for (const [path, mod] of Object.entries(schemaFiles)) {
        if (path.toLowerCase().includes(`/${camelCaseKey.toLowerCase()}/`)) {
          const module = mod as { [key: string]: { meta?: () => { description?: string } } };
          const schemaName = Object.keys(module).find((key) => key.endsWith("Schema"));

          if (schemaName) {
            schema = module[schemaName];
          }
          break;
        }
      }

      const lastPart = componentKey.split("/").pop();
      const configPath = `src/components/${componentKey}/${lastPart}.cloudcannon.structure-value.yml`;

      if (existsSync(configPath)) {
        try {
          const content = readFileSync(configPath, "utf8");

          configData = yaml.load(content);

          if (configData?._inputs_from_glob && Array.isArray(configData._inputs_from_glob)) {
            const inputs: Record<string, any> = {};
            
            for (const inputPath of configData._inputs_from_glob) {
              const resolvedPath = inputPath.startsWith("/")
                ? inputPath.slice(1)
                : `src/components/${componentKey}/${inputPath}`;
              
              if (existsSync(resolvedPath)) {
                try {
                  const inputContent = readFileSync(resolvedPath, "utf8");
                  const inputData = yaml.load(inputContent);
                  
                  if (inputData && typeof inputData === "object") {
                    Object.assign(inputs, inputData);
                  }
                } catch (error) {
                  console.error(`Error parsing input file ${resolvedPath}:`, error);
                }
              }
            }
            
            if (Object.keys(inputs).length > 0) {
              configData._inputs = inputs;
            }
          }
        } catch (error) {
          console.error(`Error parsing structure-value file ${configPath}:`, error);
        }
      }

      return {
        params: { slug: componentKey },
        props: { page: entry, schema, configData },
      };
    });
  } catch (error) {
    console.error("Error loading docs-components collection:", error);
    return [];
  }
}

const { page, schema, configData } = Astro.props;
const { Content } = await render(page);
const frontmatter = page.data;

const slugParts = page.id
  .replace(/^components\//, "")
  .replace(/\/index$/, "")
  .split("/")
  .filter(Boolean);

const componentKey = slugParts.join("/");

const searchPattern = `${componentKey}/examples/`.toLowerCase();

let examples = [];

try {
  examples = await getCollection("docs-components", ({ id }) => {
    return id && id.toLowerCase().startsWith(searchPattern);
  });
} catch (error) {
  console.error("Error loading examples:", error);
}
---

<ComponentLayout
  frontmatter={frontmatter}
  schema={schema}
  configData={configData}
  examples={examples}
  componentKey={componentKey}
>
  <Content />
</ComponentLayout>
